<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Write Problem - Solutions and Illustrations</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Nunito:wght@400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="static/styles.css">
    <style>
        :root {
            --bg-cream: #FDF8F3;
            --bg-paper: #FFFEF9;
            --accent-coral: #FF6B6B;
            --accent-teal: #4ECDC4;
            --accent-sunflower: #FFE66D;
            --accent-lavender: #C9B1FF;
            --accent-sky: #A8E6CF;
            --accent-red: #E74C3C;
            --accent-green: #27AE60;
            --accent-orange: #E67E22;
            --text-dark: #2D3436;
            --text-muted: #636E72;
            --pencil: #2B2B2B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-cream);
            color: var(--text-dark);
            line-height: 1.7;
            min-height: 100vh;
        }

        .page-wrapper {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* Sidebar TOC Styles */
        .sidebar {
            width: 280px;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-paper) 0%, #F8F4EF 100%);
            border-right: 3px solid var(--pencil);
            padding: 30px 20px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px dashed rgba(0,0,0,0.15);
        }

        .sidebar-title {
            font-family: 'Caveat', cursive;
            font-size: 1.6rem;
            color: var(--pencil);
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-family: 'Patrick Hand', cursive;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .toc-section {
            margin-bottom: 18px;
        }

        .toc-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 0.95rem;
            color: var(--pencil);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .toc-list {
            list-style: none;
            padding-left: 0;
        }

        .toc-list li {
            margin-bottom: 4px;
        }

        .toc-list a {
            display: block;
            padding: 5px 10px;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.85rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .toc-list a:hover {
            background: rgba(78, 205, 196, 0.15);
            border-left-color: var(--accent-teal);
            transform: translateX(3px);
        }

        .toc-list a.active {
            background: rgba(255, 107, 107, 0.15);
            border-left-color: var(--accent-coral);
            font-weight: 600;
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px 40px;
            max-width: calc(100vw - 320px);
            min-width: 0;
        }

        .container { max-width: 100%; margin: 0 auto; }

        header { text-align: center; margin-bottom: 50px; }

        h1 {
            font-family: 'Caveat', cursive;
            font-size: 3.5rem;
            color: var(--pencil);
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--accent-coral), var(--accent-teal), var(--accent-sunflower));
            border-radius: 3px;
            opacity: 0.6;
        }

        .subtitle { font-family: 'Patrick Hand', cursive; font-size: 1.5rem; color: var(--text-muted); margin-top: 20px; }

        .card {
            background: var(--bg-paper);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 40px;
            margin-bottom: 28px;
            box-shadow: 3px 4px 0 rgba(0,0,0,0.1), 6px 8px 0 rgba(0,0,0,0.05);
            position: relative;
            transition: transform 0.3s ease;
            border: 2px solid var(--pencil);
            scroll-margin-top: 30px;
        }

        .card:hover { transform: translate(-2px, -2px); }

        h2 { 
            font-family: 'Caveat', cursive; 
            font-size: 2.2rem; 
            color: var(--pencil); 
            margin-bottom: 20px;
            padding-left: 50px;
            position: relative;
            min-height: 45px;
            display: flex;
            align-items: center;
        }

        h2 .fa-icon {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            background: var(--bg-paper);
            border: 2px solid var(--pencil);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        h3 { font-family: 'Patrick Hand', cursive; font-size: 1.4rem; color: var(--pencil); margin: 25px 0 12px; }
        h4 { font-family: 'Patrick Hand', cursive; font-size: 1.15rem; color: var(--text-muted); margin: 18px 0 10px; }
        p { margin-bottom: 15px; font-size: 1.05rem; }

        .problem-box {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border: 3px dashed var(--accent-coral);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 25px;
            margin: 20px 0;
        }

        .problem-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.25rem;
            color: var(--accent-coral);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .solution-box {
            background: linear-gradient(135deg, #E8F8F5, #D1F2EB);
            border: 3px solid var(--accent-teal);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 28px;
            margin: 22px 0;
        }

        .solution-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.3rem;
            color: var(--accent-teal);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .highlight-box {
            background: linear-gradient(135deg, #FFFDE7, #FFF9C4);
            border: 3px dashed var(--accent-sunflower);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 22px;
            margin: 20px 0;
            text-align: center;
        }

        .highlight-box p {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.15rem;
            color: var(--text-dark);
            margin: 8px 0;
        }

        .insight-box {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 22px;
            margin: 22px 0;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border: 3px solid var(--accent-teal);
        }

        .insight-icon { font-size: 1.8rem; flex-shrink: 0; }

        .flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .flow-item {
            padding: 14px 22px;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            border: 3px solid var(--pencil);
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            background: var(--bg-paper);
            text-align: center;
        }

        .flow-item.success { background: #E8F5E9; border-color: var(--accent-teal); }
        .flow-item.error { background: #FFEBEE; border-color: var(--accent-coral); }
        .flow-item.warning { background: #FFF8E1; border-color: var(--accent-orange); }

        .flow-arrow { font-size: 1.6rem; color: var(--accent-lavender); }

        .action-card {
            background: linear-gradient(135deg, #F8F5FF, #F0FFFA);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 24px;
            margin: 16px 0;
            border: 3px solid var(--accent-lavender);
        }

        .action-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.25rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-number {
            width: 32px;
            height: 32px;
            background: var(--accent-coral);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid var(--pencil);
        }

        .comparison-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 22px 0;
            font-size: 0.9rem;
            border: 2px solid var(--pencil);
            border-radius: 15px;
            overflow: hidden;
        }

        .comparison-table th, .comparison-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px dashed rgba(0,0,0,0.12);
        }

        .comparison-table th {
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            background: #F5F0E8;
        }

        .comparison-table tr:last-child td { border-bottom: none; }

        .check { color: var(--accent-teal); font-weight: bold; }
        .cross { color: var(--accent-coral); font-weight: bold; }

        .checklist {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .checklist li {
            padding: 8px 0 8px 30px;
            position: relative;
            border-bottom: 2px dashed rgba(0,0,0,0.06);
        }

        .checklist li::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            font-size: 0.9rem;
            color: var(--accent-teal);
        }

        .divider {
            text-align: center;
            margin: 40px 0;
        }

        .divider::before {
            content: '~~~~~~~';
            font-family: 'Caveat', cursive;
            font-size: 1.5rem;
            color: var(--accent-lavender);
            letter-spacing: 10px;
        }

        .code-block {
            background: #2D3436;
            color: #E8F4F8;
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 15px 0;
            overflow-x: auto;
            border: 2px solid var(--pencil);
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-family: 'Patrick Hand', cursive;
            border-top: 2px dashed var(--pencil);
            margin-top: 40px;
        }

        .back-link {
            display: inline-block;
            color: var(--accent-teal);
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            text-decoration: none;
            margin-bottom: 25px;
            transition: color 0.3s;
        }
        .back-link:hover { color: var(--accent-coral); }

        @media (max-width: 1100px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; max-width: 100%; padding: 25px 20px; }
            h1 { font-size: 2.5rem; }
            .card { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Table of Contents -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Dual Write</div>
                <div class="sidebar-subtitle">Navigation</div>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-triangle-exclamation"></i> Problem</div>
                <ul class="toc-list">
                    <li><a href="#problem" onclick="scrollToSection('problem')">What is It?</a></li>
                    <li><a href="#why-fail" onclick="scrollToSection('why-fail')">Why Simple Solutions Fail</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-lightbulb"></i> Solutions</div>
                <ul class="toc-list">
                    <li><a href="#outbox" onclick="scrollToSection('outbox')">1. Outbox Pattern</a></li>
                    <li><a href="#sourcing" onclick="scrollToSection('sourcing')">2. Event Sourcing</a></li>
                    <li><a href="#listen" onclick="scrollToSection('listen')">3. Listen to Yourself</a></li>
                    <li><a href="#cdc" onclick="scrollToSection('cdc')">4. CDC</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-rotate"></i> Production</div>
                <ul class="toc-list">
                    <li><a href="#2pc" onclick="scrollToSection('2pc')">Two-Phase Commit + Reconcile</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-scale-balanced"></i> Comparison</div>
                <ul class="toc-list">
                    <li><a href="#comparison" onclick="scrollToSection('comparison')">Pattern Comparison</a></li>
                    <li><a href="#choose" onclick="scrollToSection('choose')">Which to Use?</a></li>
                </ul>
            </div>

            <div class="toc-section" style="margin-top: 25px; padding-top: 18px; border-top: 2px dashed rgba(0,0,0,0.1);">
                <a href="index.html" style="display: flex; align-items: center; gap: 8px; color: var(--accent-teal); text-decoration: none; font-weight: 600; font-family: 'Patrick Hand', cursive;">
                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to Mind & Machine</a>
                
                <header>
                    <h1>The Dual Write Problem</h1>
                    <p class="subtitle">Understanding and Solving the Atomic Write Challenge in Microservices</p>
                    <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                        <i class="fa-solid fa-user"></i> Jiuhe Wang &nbsp;|&nbsp; 
                        <i class="fa-regular fa-calendar"></i> Created: Feb 22, 2026
                    </p>
                </header>

                <!-- Problem -->
                <section class="card" id="problem">
                    <h2><i class="fa-solid fa-triangle-exclamation fa-icon"></i>What is the Dual Write Problem?</h2>
                    <p>The <strong>Dual Write Problem</strong> occurs when a microservice needs to write to two external systems (like a database AND Apache Kafka) in an atomic fashion, but these systems cannot be wrapped in a single transaction.</p>
                    
                    <div class="problem-box">
                        <div class="problem-title">
                            <i class="fa-solid fa-building-columns"></i> Real-World Example: Banking Transaction
                        </div>
                        <p>When a user pays a bill, the system must:</p>
                        <p>1. <strong>Write to database:</strong> Update the account balance (money deducted)</p>
                        <p>2. <strong>Emit event to Kafka:</strong> Trigger the payment processing</p>
                        <p><strong>The problem:</strong> If the database write succeeds but Kafka fails, money is gone but payment never happens!</p>
                    </div>
                    
                    <div class="flow-row">
                        <div class="flow-item success">Database Write</div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item error">Kafka Write (FAILS)</div>
                        <div class="flow-arrow">=</div>
                        <div class="flow-item warning">INCONSISTENT!</div>
                    </div>
                </section>

                <!-- Why Simple Solutions Fail -->
                <section class="card" id="why-fail">
                    <h2><i class="fa-solid fa-xmark fa-icon"></i>Why Simple Solutions Do Not Work</h2>
                    
                    <div class="solution-box" style="border-color: var(--accent-coral); background: linear-gradient(135deg, #FFEBEE, #FFCDD2);">
                        <div class="solution-title" style="color: var(--accent-coral);">
                            <span style="background: var(--accent-coral); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem;">1</span>
                            Emit Event First, Then Write Database
                        </div>
                        <p><strong>Still has the problem!</strong> If database write fails after event is emitted, you have an event for a transaction that never happened. The system is still inconsistent.</p>
                    </div>
                    
                    <div class="solution-box" style="border-color: var(--accent-coral); background: linear-gradient(135deg, #FFEBEE, #FFCDD2);">
                        <div class="solution-title" style="color: var(--accent-coral);">
                            <span style="background: var(--accent-coral); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem;">2</span>
                            Use a Database Transaction
                        </div>
                        <p><strong>Still does not work!</strong> There is no transaction spanning both database AND Kafka. If event is published but transaction is not committed, the event goes out but state rolls back!</p>
                    </div>
                </section>

                <!-- Solutions -->
                <section class="card" id="solutions">
                    <h2><i class="fa-solid fa-check fa-icon"></i>Solutions to the Dual Write Problem</h2>
                    
                    <!-- Outbox -->
                    <div class="solution-box" id="outbox">
                        <div class="solution-title">
                            <i class="fa-solid fa-inbox"></i> 1. Transactional Outbox Pattern
                        </div>
                        <p>Use a database transaction to write BOTH your data AND an "outbox" table. A separate process then reads the outbox and publishes to Kafka.</p>
                        
                        <div class="flow-row">
                            <div class="flow-item">User Request</div>
                            <div class="flow-arrow">-&gt;</div>
                            <div class="flow-item success">1 Transaction</div>
                            <div class="flow-arrow">-&gt;</div>
                            <div class="flow-item">Data + Outbox</div>
                        </div>
                        <div class="flow-row">
                            <div class="flow-item" style="background: #F3E5F5;">CDC/Worker</div>
                            <div class="flow-arrow">-&gt;</div>
                            <div class="flow-item">Kafka</div>
                        </div>
                        
                        <div class="checklist">
                            <li>Write to Database + Outbox in Single Transaction</li>
                            <li>Respond to User (success)</li>
                            <li>Separate Process Reads Outbox</li>
                            <li>Publish to Kafka (at-least-once)</li>
                        </div>
                    </div>

                    <!-- Event Sourcing -->
                    <div class="solution-box" id="sourcing" style="border-color: var(--accent-sunflower); background: linear-gradient(135deg, #FFFDE7, #FFF3B0);">
                        <div class="solution-title" style="color: #B8860B;">
                            <i class="fa-solid fa-scroll"></i> 2. Event Sourcing
                        </div>
                        <p>Do not store current state - store ONLY the sequence of events. The state is reconstructed by replaying events. Kafka IS your database!</p>
                        
                        <div class="highlight-box">
                            <p><strong>Banks use this!</strong> They do not store your balance - they store all transactions!</p>
                        </div>
                        
                        <div class="checklist">
                            <li>Store Events Only (append to event log)</li>
                            <li>Kafka as Event Store (durable, ordered)</li>
                            <li>Reconstruct on Read (or use snapshots)</li>
                        </div>
                    </div>

                    <!-- Listen to Yourself -->
                    <div class="solution-box" id="listen" style="border-color: var(--accent-lavender); background: linear-gradient(135deg, #F3E5F5, #E1BEE7);">
                        <div class="solution-title" style="color: #7B1FA2;">
                            <i class="fa-solid fa-ear-listen"></i> 3. Listen to Yourself Pattern
                        </div>
                        <p>Write to Kafka FIRST, then have your own service consume that event to update the database. You are both producer AND consumer!</p>
                        
                        <div class="highlight-box">
                            <p><strong>Great for fast responses!</strong> User gets immediate acknowledgment, processing happens async.</p>
                        </div>
                        
                        <div class="checklist">
                            <li>Write Only to Kafka (no DB write!)</li>
                            <li>Respond to User immediately</li>
                            <li>Consume Your Own Events</li>
                            <li>Update Database (async)</li>
                        </div>
                    </div>

                    <!-- CDC -->
                    <div class="solution-box" id="cdc" style="border-color: var(--accent-orange); background: linear-gradient(135deg, #FFF3E0, #FFE0B2);">
                        <div class="solution-title" style="color: #E65100;">
                            <i class="fa-solid fa-radar"></i> 4. Change Data Capture (CDC)
                        </div>
                        <p>Let a CDC tool (like Debezium) monitor your database and automatically stream changes to Kafka. No code changes needed!</p>
                        
                        <div class="checklist">
                            <li>No application code needed</li>
                            <li>Works with existing apps</li>
                            <li>Captures all changes</li>
                            <li>Low latency</li>
                        </div>
                    </div>
                </section>

                <!-- Reconciliation -->
                <section class="card" id="2pc">
                    <h2><i class="fa-solid fa-rotate fa-icon"></i>Real-World: Two-Phase Commit with Reconciliation</h2>
                    
                    <p>In production, the patterns above are not enough. A robust implementation uses <strong>Two-Phase Commit (2PC)</strong> or <strong>Multi-Phase Commit</strong> with reconciliation:</p>
                    
                    <div class="insight-box">
                        <div class="insight-icon"><i class="fa-solid fa-lightbulb"></i></div>
                        <div>
                            <strong>Key Insight:</strong> In real systems, failures are not exceptions - they are expected. You need a mechanism to detect and recover from stuck records.
                        </div>
                    </div>
                    
                    <h3>The State Machine Approach</h3>
                    
                    <div class="flow-row">
                        <div class="flow-item" style="background: #E3F2FD;">
                            <strong>INITIALIZED</strong><br><span style="font-size: 0.85rem;">Record created</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item" style="background: #FFF3E0;">
                            <strong>PROCESSING</strong><br><span style="font-size: 0.85rem;">Event being emitted</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item success">
                            <strong>SUCCESS</strong><br><span style="font-size: 0.85rem;">Event emitted</span>
                        </div>
                    </div>
                    
                    <h3>How It Works</h3>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">1</span>
                            Initial Record with Status Tracking
                        </div>
                        <p>Instead of just writing data, add a <code>status</code> field: <code>initialized</code>, <code>processing</code>, <code>success</code>, <code>failed</code>. The initial write creates the record in <code>initialized</code> state.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">2</span>
                            Mark as Processing Before Emitting
                        </div>
                        <p>Before emitting the event (via CDC or outbox), atomically update the record status from <code>initialized</code> to <code>processing</code>. This prevents duplicate emission if the process crashes and restarts.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">3</span>
                            Mark Success After Confirmed Emit
                        </div>
                        <p>After the event is successfully published to Kafka (with confirmation), update status to <code>success</code>. Only now is the record considered fully processed.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">4</span>
                            Scheduled Reconciliation Job
                        </div>
                        <p>A daily (or hourly) scheduled job queries for records stuck in <code>initialized</code> or <code>processing</code> state for longer than expected threshold. These are flagged for manual review or automatic retry.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">5</span>
                            Idempotent Replay
                        </div>
                        <p>When reconciling stuck records, re-emit the event. The downstream consumer MUST be idempotent - it should handle duplicate events gracefully (using event ID or business key dedup).</p>
                    </div>
                    
                    <div class="highlight-box">
                        <p><strong>The Safety Net:</strong> Records that never make it to SUCCESS will appear in the reconciliation report. You can then investigate and replay safely because idempotency guarantees no duplicate side effects.</p>
                    </div>
                    
                    <h3>Database Schema Example</h3>
                    
                    <div class="code-block">
<pre>CREATE TABLE outbox (
    id              UUID PRIMARY KEY,
    aggregate_id   UUID NOT NULL,
    event_type      VARCHAR(100) NOT NULL,
    payload        JSONB NOT NULL,
    status         VARCHAR(20) DEFAULT 'initialized',
    retry_count    INT DEFAULT 0,
    created_at     TIMESTAMP DEFAULT NOW(),
    processed_at    TIMESTAMP,
    error_message  TEXT
);

-- Index for reconciliation
CREATE INDEX idx_outbox_stuck 
ON outbox(status, created_at) 
WHERE status IN ('initialized', 'processing');</pre>
                    </div>
                </section>

                <!-- Comparison -->
                <section class="card" id="comparison">
                    <h2><i class="fa-solid fa-scale-balanced fa-icon"></i>Solution Comparison</h2>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Consistency</th>
                                <th>Complexity</th>
                                <th>Latency</th>
                                <th>Audit Trail</th>
                                <th>Reconciliation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Transactional Outbox</td>
                                <td class="check">[+] Strong</td>
                                <td>Medium</td>
                                <td>Low</td>
                                <td class="cross">[-]</td>
                                <td>Recommended</td>
                            </tr>
                            <tr>
                                <td>Event Sourcing</td>
                                <td class="check">[+] Strong</td>
                                <td>High</td>
                                <td>Medium</td>
                                <td class="check">[+] Complete</td>
                                <td>Built-in</td>
                            </tr>
                            <tr>
                                <td>Listen to Yourself</td>
                                <td class="cross">[-] Eventual</td>
                                <td>Low</td>
                                <td>Very Low</td>
                                <td class="check">[+]</td>
                                <td>Recommended</td>
                            </tr>
                            <tr>
                                <td>CDC</td>
                                <td class="check">[+] Strong</td>
                                <td>Medium</td>
                                <td>Low</td>
                                <td class="cross">[-]</td>
                                <td>Recommended</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Which to Use -->
                <section class="card" id="choose">
                    <h2><i class="fa-solid fa-question fa-icon"></i>Which Pattern to Use?</h2>
                    
                    <div class="solution-box">
                        <div class="solution-title">Use Transactional Outbox when:</div>
                        <ul class="checklist">
                            <li>You have a transactional database</li>
                            <li>You need strong consistency</li>
                            <li>You want a simple, well-understood pattern</li>
                            <li>Regulatory compliance requires atomicity</li>
                            <li><strong>Always add reconciliation for production!</strong></li>
                        </ul>
                    </div>
                    
                    <div class="solution-box" style="border-color: var(--accent-sunflower); background: linear-gradient(135deg, #FFFDE7, #FFF3B0);">
                        <div class="solution-title" style="color: #B8860B;">Use Event Sourcing when:</div>
                        <ul class="checklist">
                            <li>Complete audit trail is required (banking, healthcare)</li>
                            <li>You need to replay events for debugging</li>
                            <li>Business domain naturally fits event model</li>
                            <li>You need temporal queries ("state at time X")</li>
                        </ul>
                    </div>
                    
                    <div class="solution-box" style="border-color: var(--accent-lavender); background: linear-gradient(135deg, #F3E5F5, #E1BEE7);">
                        <div class="solution-title" style="color: #7B1FA2;">Use Listen to Yourself when:</div>
                        <ul class="checklist">
                            <li>Fast response time is critical</li>
                            <li>Complex processing can be deferred</li>
                            <li>Eventual consistency is acceptable</li>
                            <li>Processing can happen async</li>
                        </ul>
                    </div>
                    
                    <div class="solution-box" style="border-color: var(--accent-orange); background: linear-gradient(135deg, #FFF3E0, #FFE0B2);">
                        <div class="solution-title" style="color: #E65100;">Use CDC when:</div>
                        <ul class="checklist">
                            <li>You cannot modify existing application code</li>
                            <li>You need to capture legacy system changes</li>
                            <li>Real-time change notification needed</li>
                            <li>Existing app already writes to database</li>
                        </ul>
                    </div>
                </section>

                <!-- Key Takeaways -->
                <section class="card" id="takeaways">
                    <h2><i class="fa-solid fa-star fa-icon"></i>Key Takeaways</h2>
                    
                    <div class="highlight-box">
                        <p>1. The dual write problem is real and dangerous - do not ignore it!</p>
                        <p>2. Never assume both writes will succeed - plan for failure</p>
                        <p>3. Choose the pattern that fits your consistency requirements</p>
                        <p>4. At-least-once delivery is common - build idempotent consumers</p>
                        <p>5. <strong>Always implement reconciliation for production systems!</strong></p>
                        <p>6. Test your failure scenarios!</p>
                    </div>
                </section>
                
                <footer>
                    <p>Study notes based on Confluent Developer Courses</p>
                    <p>Dual Write Problem | Transactional Outbox | Event Sourcing | CDC | Reconciliation</p>
                </footer>
            </div>
        </main>
    </div>

    <script>
        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                const offset = 30;
                const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
                window.scrollTo({ top: elementPosition - offset, behavior: 'smooth' });
            }
        }

        // Scroll spy
        const sections = document.querySelectorAll('.card[id]');
        const tocLinks = document.querySelectorAll('.toc-list a');

        function highlightToc() {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.scrollY >= sectionTop - 150) {
                    current = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', highlightToc);
        highlightToc();
    </script>
</body>
</html>
