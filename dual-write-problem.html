<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Understanding the dual write problem in distributed systems: solutions including CDC, transactional outbox, and saga pattern with visual illustrations.">
    <meta name="keywords" content="dual write problem, distributed systems, CDC, change data capture, transactional outbox, saga pattern, data consistency">
    <meta name="author" content="Jiuhe Wang">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://wjiuhe.github.io/ai-notes/dual-write-problem.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://wjiuhe.github.io/ai-notes/dual-write-problem.html">
    <meta property="og:title" content="Dual Write Problem: Solutions and Patterns">
    <meta property="og:description" content="Understanding the dual write problem: CDC, transactional outbox, and saga pattern solutions.">
    <meta property="og:site_name" content="Mind & Machine">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://wjiuhe.github.io/ai-notes/dual-write-problem.html">
    <meta property="twitter:title" content="Dual Write Problem Solutions">
    <meta property="twitter:description" content="Understanding the dual write problem in distributed systems.">

    <title>Dual Write Problem: CDC, Outbox & Saga Patterns | Mind & Machine</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Nunito:wght@400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="static/styles.css">
    <style>
        /* Page-specific styles only - common styles are in shared CSS */

        /* Problem & Solution Boxes */
        .problem-box {
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border: 3px dashed var(--accent-coral);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 25px;
            margin: 20px 0;
        }
        .problem-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.25rem;
            color: var(--accent-coral);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .solution-box {
            background: linear-gradient(135deg, #E8F8F5, #D1F2EB);
            border: 3px solid var(--accent-teal);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 28px;
            margin: 22px 0;
        }
        .solution-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.3rem;
            color: var(--accent-teal);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .highlight-box {
            background: linear-gradient(135deg, #FFFDE7, #FFF9C4);
            border: 3px dashed var(--accent-sunflower);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 22px;
            margin: 20px 0;
            text-align: center;
        }
        .highlight-box p {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.15rem;
            color: var(--text-dark);
            margin: 8px 0;
        }

        .insight-box {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 22px;
            margin: 22px 0;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border: 3px solid var(--accent-teal);
        }
        .insight-icon { font-size: 1.8rem; flex-shrink: 0; }

        /* Flow Row */
        .flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .flow-item {
            padding: 14px 22px;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            border: 3px solid var(--pencil);
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            background: var(--bg-paper);
            text-align: center;
        }
        .flow-item.success { background: #E8F5E9; border-color: var(--accent-teal); }
        .flow-item.error { background: #FFEBEE; border-color: var(--accent-coral); }
        .flow-item.warning { background: #FFF8E1; border-color: var(--accent-orange); }
        .flow-arrow { font-size: 1.6rem; color: var(--accent-lavender); }

        /* Action Card */
        .action-card {
            background: linear-gradient(135deg, #F8F5FF, #F0FFFA);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 24px;
            margin: 16px 0;
            border: 3px solid var(--accent-lavender);
        }
        .action-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.25rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .action-number {
            width: 32px;
            height: 32px;
            background: var(--accent-coral);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid var(--pencil);
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 22px 0;
            font-size: 0.9rem;
            border: 2px solid var(--pencil);
            border-radius: 15px;
            overflow: hidden;
        }
        .comparison-table th, .comparison-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px dashed rgba(0,0,0,0.12);
        }
        .comparison-table th {
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            background: #F5F0E8;
        }
        .comparison-table tr:last-child td { border-bottom: none; }
        .check { color: var(--accent-teal); font-weight: bold; }
        .cross { color: var(--accent-coral); font-weight: bold; }

        /* Checklist */
        .checklist { list-style: none; padding: 0; margin: 15px 0; }
        .checklist li {
            padding: 8px 0 8px 30px;
            position: relative;
            border-bottom: 2px dashed rgba(0,0,0,0.06);
        }
        .checklist li::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            font-size: 0.9rem;
            color: var(--accent-teal);
        }

        /* Divider */
        .divider { text-align: center; margin: 40px 0; }
        .divider::before {
            content: '~~~~~~~';
            font-family: 'Caveat', cursive;
            font-size: 1.5rem;
            color: var(--accent-lavender);
            letter-spacing: 10px;
        }

        /* Code Block */
        .code-block {
            background: #2D3436;
            color: #E8F4F8;
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 15px 0;
            overflow-x: auto;
            border: 2px solid var(--pencil);
        }

        /* Strategy Grid */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .strategy-card {
            background: var(--bg-paper);
            border: 2px solid var(--pencil);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .strategy-card:hover { transform: translateY(-3px); box-shadow: 3px 4px 0 rgba(0,0,0,0.15); }
        .strategy-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
            color: white;
            border: 2px solid var(--pencil);
        }
        .strategy-name {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
            color: var(--pencil);
            margin-bottom: 8px;
        }
        .strategy-use { font-size: 0.85rem; color: var(--accent-teal); font-weight: 600; margin-bottom: 4px; }
        .strategy-when { font-size: 0.8rem; color: var(--text-muted); }

        /* Component Box */
        .component-box {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: var(--bg-paper);
            border: 2px solid var(--pencil);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            margin: 10px 0;
        }
        .component-icon-large {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
            border: 2px solid var(--pencil);
        }
        .component-text { flex: 1; }
        .component-name {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.15rem;
            color: var(--pencil);
            margin-bottom: 3px;
        }
        .component-desc { font-size: 0.85rem; color: var(--text-muted); }

        /* Architecture Diagram */
        .arch-diagram {
            background: #fafafa;
            border: 2px dashed var(--pencil);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .arch-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 20px;
        }
        .arch-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .arch-node {
            padding: 12px 18px;
            border-radius: 12px;
            border: 2px solid var(--pencil);
            text-align: center;
            min-width: 100px;
        }
        .arch-node-db { background: #E3F2FD; }
        .arch-node-kafka { background: #F3E5F5; }
        .arch-node-worker { background: #FFF3E0; }
        .arch-node-app { background: #E8F5E9; }
        .arch-node-cdc { background: #FFEBEE; }
        .arch-node-icon { font-size: 1.4rem; margin-bottom: 4px; }
        .arch-node-label { font-size: 0.8rem; font-weight: 600; }
        .arch-arrow { font-size: 1.4rem; color: var(--accent-lavender); }
        .arch-arrow-down { transform: rotate(90deg); }

        /* Example Box */
        .example-box {
            background: #f0f7ff;
            border: 2px dashed var(--accent-teal);
            border-radius: 15px;
            padding: 18px;
            margin-top: 18px;
        }
        .example-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.15rem;
            color: var(--accent-teal);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .example-box p { font-size: 0.95rem; margin-bottom: 8px; padding-left: 10px; }
        .example-box code { background: rgba(0,0,0,0.08); padding: 2px 6px; border-radius: 4px; }

        /* Mobile Overrides - Page Specific */
        @media (max-width: 768px) {
            .strategy-grid { grid-template-columns: 1fr; }
            .component-box { flex-direction: column; text-align: center; }
            .flow-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <button class="toc-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>

    <div class="page-wrapper">
        <!-- Sidebar Table of Contents -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Dual Write</div>
                <div class="sidebar-subtitle">Navigation</div>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-triangle-exclamation"></i> Problem</div>
                <ul class="toc-list">
                    <li><a href="#problem" onclick="scrollToSection('problem')">What is It?</a></li>
                    <li><a href="#why-fail" onclick="scrollToSection('why-fail')">Why Simple Solutions Fail</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-lightbulb"></i> Solutions</div>
                <ul class="toc-list">
                    <li><a href="#outbox" onclick="scrollToSection('outbox')">1. Outbox Pattern</a></li>
                    <li><a href="#sourcing" onclick="scrollToSection('sourcing')">2. Event Sourcing</a></li>
                    <li><a href="#listen" onclick="scrollToSection('listen')">3. Listen to Yourself</a></li>
                    <li><a href="#cdc" onclick="scrollToSection('cdc')">4. CDC</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-rotate"></i> Production</div>
                <ul class="toc-list">
                    <li><a href="#2pc" onclick="scrollToSection('2pc')">Two-Phase Commit + Reconcile</a></li>
                </ul>
            </div>

            <div class="toc-section">
                <div class="toc-title"><i class="fa-solid fa-scale-balanced"></i> Comparison</div>
                <ul class="toc-list">
                    <li><a href="#comparison" onclick="scrollToSection('comparison')">Pattern Comparison</a></li>
                    <li><a href="#choose" onclick="scrollToSection('choose')">Which to Use?</a></li>
                </ul>
            </div>

            <div class="toc-section" style="margin-top: 25px; padding-top: 18px; border-top: 2px dashed rgba(0,0,0,0.1);">
                <a href="index.html" style="display: flex; align-items: center; gap: 8px; color: var(--accent-teal); text-decoration: none; font-weight: 600; font-family: 'Patrick Hand', cursive;">
                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to Mind & Machine</a>
                
                <header>
                    <h1>The Dual Write Problem</h1>
                    <p class="subtitle">Understanding and Solving the Atomic Write Challenge in Microservices</p>
                    <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                        <i class="fa-solid fa-user"></i> Jiuhe Wang &nbsp;|&nbsp; 
                        <i class="fa-regular fa-calendar"></i> Created: Feb 22, 2026
                    </p>
                </header>

                <!-- Problem -->
                <section class="card" id="problem">
                    <h2><i class="fa-solid fa-triangle-exclamation fa-icon"></i>What is the Dual Write Problem?</h2>
                    <p>The <strong>Dual Write Problem</strong> occurs when a microservice needs to write to two external systems (like a database AND Apache Kafka) in an atomic fashion, but these systems cannot be wrapped in a single transaction.</p>
                    
                    <div class="problem-box">
                        <div class="problem-title">
                            <i class="fa-solid fa-building-columns"></i> Real-World Example: Banking Transaction
                        </div>
                        <p>When a user pays a bill, the system must:</p>
                        <p>1. <strong>Write to database:</strong> Update the account balance (money deducted)</p>
                        <p>2. <strong>Emit event to Kafka:</strong> Trigger the payment processing</p>
                        <p><strong>The problem:</strong> If the database write succeeds but Kafka fails, money is gone but payment never happens!</p>
                    </div>
                    
                    <div class="flow-row">
                        <div class="flow-item success">Database Write</div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item error">Kafka Write (FAILS)</div>
                        <div class="flow-arrow">=</div>
                        <div class="flow-item warning">INCONSISTENT!</div>
                    </div>
                </section>

                <!-- Why Simple Solutions Fail -->
                <section class="card" id="why-fail">
                    <h2><i class="fa-solid fa-xmark fa-icon"></i>Why Simple Solutions Do Not Work</h2>
                    
                    <div class="solution-box" style="border-color: var(--accent-coral); background: linear-gradient(135deg, #FFEBEE, #FFCDD2);">
                        <div class="solution-title" style="color: var(--accent-coral);">
                            <span style="background: var(--accent-coral); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem;">1</span>
                            Emit Event First, Then Write Database
                        </div>
                        <p><strong>Still has the problem!</strong> If database write fails after event is emitted, you have an event for a transaction that never happened. The system is still inconsistent.</p>
                    </div>
                    
                    <div class="solution-box" style="border-color: var(--accent-coral); background: linear-gradient(135deg, #FFEBEE, #FFCDD2);">
                        <div class="solution-title" style="color: var(--accent-coral);">
                            <span style="background: var(--accent-coral); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem;">2</span>
                            Use a Database Transaction
                        </div>
                        <p><strong>Still does not work!</strong> There is no transaction spanning both database AND Kafka. If event is published but transaction is not committed, the event goes out but state rolls back!</p>
                    </div>
                </section>

                <!-- Solutions -->
                <section class="card" id="solutions">
                    <h2><i class="fa-solid fa-check fa-icon"></i>Solutions to the Dual Write Problem</h2>
                    
                    <!-- Outbox -->
                    <div class="solution-box" id="outbox">
                        <div class="solution-title">
                            <i class="fa-solid fa-inbox"></i> 1. Transactional Outbox Pattern
                        </div>
                        
                        <div class="arch-diagram">
                            <div class="arch-title">How It Works</div>
                            <div class="arch-flow">
                                <div class="arch-node arch-node-app">
                                    <div class="arch-node-icon"><i class="fa-solid fa-user"></i></div>
                                    <div class="arch-node-label">App</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-db" style="background: #BBDEFB;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-database"></i></div>
                                    <div class="arch-node-label">DB + Outbox</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-worker">
                                    <div class="arch-node-icon"><i class="fa-solid fa-gear"></i></div>
                                    <div class="arch-node-label">Worker</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-kafka">
                                    <div class="arch-node-icon"><i class="fa-solid fa-bolt"></i></div>
                                    <div class="arch-node-label">Kafka</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                            <div class="component-box">
                                <div class="component-icon-large" style="background: #BBDEFB;"><i class="fa-solid fa-plus"></i></div>
                                <div class="component-text">
                                    <div class="component-name">Single Transaction</div>
                                    <div class="component-desc">Write data + event to outbox atomically</div>
                                </div>
                            </div>
                            <div class="component-box">
                                <div class="component-icon-large" style="background: #FFE0B2;"><i class="fa-solid fa-bell"></i></div>
                                <div class="component-text">
                                    <div class="component-name">Async Publish</div>
                                    <div class="component-desc">Worker reads outbox, sends to Kafka</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="example-box">
                            <div class="example-title"><i class="fa-solid fa-cart-shopping"></i> Example: Order Processing</div>
                            <p>1. User places order -> write to <code>orders</code> table + <code>outbox</code> table in ONE transaction</p>
                            <p>2. Return "Order placed!" to user immediately</p>
                            <p>3. Background worker reads outbox -> publishes "OrderCreated" event to Kafka</p>
                            <p>4. Notification service consumes event -> sends email to user</p>
                        </div>
                    </div>

                    <!-- Event Sourcing -->
                    <div class="solution-box" id="sourcing" style="border-color: var(--accent-sunflower); background: linear-gradient(135deg, #FFFDE7, #FFF3B0);">
                        <div class="solution-title" style="color: #B8860B;">
                            <i class="fa-solid fa-scroll"></i> 2. Event Sourcing
                        </div>
                        
                        <div class="arch-diagram">
                            <div class="arch-title">Events = Source of Truth</div>
                            <div class="arch-flow">
                                <div class="arch-node arch-node-kafka" style="background: #E1BEE7;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-list"></i></div>
                                    <div class="arch-node-label">Event Log</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node" style="background: #FFF9C4;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-play"></i></div>
                                    <div class="arch-node-label">Replay</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node" style="background: #C8E6C9;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-warehouse"></i></div>
                                    <div class="arch-node-label">State</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="component-box" style="background: #FFFDE7;">
                            <div class="component-icon-large" style="background: #FFE082;"><i class="fa-solid fa-building-columns"></i></div>
                            <div class="component-text">
                                <div class="component-name">Banks Store Transactions, Not Balances</div>
                                <div class="component-desc">Your balance is derived by summing all transactions</div>
                            </div>
                        </div>
                        
                        <div class="example-box" style="border-color: var(--accent-sunflower); background: #FFFDE7;">
                            <div class="example-title" style="color: #B8860B;"><i class="fa-solid fa-university"></i> Example: Bank Account</div>
                            <p>1. Instead of storing <code>balance = $1000</code>, store: <code>Deposited $500</code>, <code>Withdrew $200</code>, <code>Deposited $700</code></p>
                            <p>2. Current balance = $500 - $200 + $700 = $1000 (computed on read)</p>
                            <p>3. Any state can be reconstructed by replaying all events from the beginning</p>
                            <p>4. To transfer $100: record <code>DebitEvent(acc A, $100)</code> + <code>CreditEvent(acc B, $100)</code></p>
                            <p>5. Event store is the single source of truth - Kafka holds all history</p>
                        </div>
                    </div>

                    <!-- Listen to Yourself -->
                    <div class="solution-box" id="listen" style="border-color: var(--accent-lavender); background: linear-gradient(135deg, #F3E5F5, #E1BEE7);">
                        <div class="solution-title" style="color: #7B1FA2;">
                            <i class="fa-solid fa-ear-listen"></i> 3. Listen to Yourself Pattern
                        </div>
                        
                        <div class="arch-diagram">
                            <div class="arch-title">Reverse the Flow</div>
                            <div class="arch-flow">
                                <div class="arch-node arch-node-app">
                                    <div class="arch-node-icon"><i class="fa-solid fa-user"></i></div>
                                    <div class="arch-node-label">App</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-kafka" style="background: #CE93D8;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-bolt"></i></div>
                                    <div class="arch-node-label">Kafka</div>
                                </div>
                            </div>
                            <div class="arch-flow" style="margin-top: 15px;">
                                <div class="arch-node" style="background: #E1BEE7;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-ear-listen"></i></div>
                                    <div class="arch-node-label">Self-Consumer</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-db">
                                    <div class="arch-node-icon"><i class="fa-solid fa-database"></i></div>
                                    <div class="arch-node-label">DB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="component-box" style="background: #F3E5F5;">
                            <div class="component-icon-large" style="background: #CE93D8;"><i class="fa-solid fa-bolt"></i></div>
                            <div class="component-text">
                                <div class="component-name">Fast Response First</div>
                                <div class="component-desc">Write to Kafka, respond immediately, then update DB async</div>
                            </div>
                        </div>
                        
                        <div class="example-box" style="border-color: var(--accent-lavender); background: #F3E5F5;">
                            <div class="example-title" style="color: #7B1FA2;"><i class="fa-solid fa-bell"></i> Example: Order Confirmation</div>
                            <p>1. User clicks "Place Order" -> immediately publish <code>OrderCreated</code> event to Kafka</p>
                            <p>2. Return "Order confirmed!" to user (very fast, ~10ms)</p>
                            <p>3. A consumer within the same service reads the event and writes to local database</p>
                            <p>4. If DB write fails: consumer retries until it succeeds (idempotent)</p>
                            <p>5. User sees confirmation immediately, background syncs the state</p>
                        </div>
                    </div>

                    <!-- CDC -->
                    <div class="solution-box" id="cdc" style="border-color: var(--accent-orange); background: linear-gradient(135deg, #FFF3E0, #FFE0B2);">
                        <div class="solution-title" style="color: #E65100;">
                            <i class="fa-solid fa-database"></i> 4. Change Data Capture (CDC)
                        </div>
                        
                        <div class="arch-diagram">
                            <div class="arch-title">Database Watching</div>
                            <div class="arch-flow">
                                <div class="arch-node arch-node-db">
                                    <div class="arch-node-icon"><i class="fa-solid fa-database"></i></div>
                                    <div class="arch-node-label">Database</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node" style="background: #FFAB91;">
                                    <div class="arch-node-icon"><i class="fa-solid fa-eye"></i></div>
                                    <div class="arch-node-label">CDC Tool</div>
                                </div>
                                <div class="arch-arrow">-&gt;</div>
                                <div class="arch-node arch-node-kafka">
                                    <div class="arch-node-icon"><i class="fa-solid fa-bolt"></i></div>
                                    <div class="arch-node-label">Kafka</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                            <div class="component-box" style="background: #FFF3E0;">
                                <div class="component-icon-large" style="background: #FF8A65;"><i class="fa-solid fa-eye"></i></div>
                                <div class="component-text">
                                    <div class="component-name">No Code Change</div>
                                    <div class="component-desc">Monitors DB binlog, streams changes</div>
                                </div>
                            </div>
                            <div class="component-box" style="background: #FFF3E0;">
                                <div class="component-icon-large" style="background: #FF8A65;"><i class="fa-solid fa-clock-rotate-left"></i></div>
                                <div class="component-text">
                                    <div class="component-name">Legacy Friendly</div>
                                    <div class="component-desc">Works with existing applications</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="example-box" style="border-color: var(--accent-orange); background: #FFF3E0;">
                            <div class="example-title" style="color: #E65100;"><i class="fa-solid fa-magnifying-glass"></i> Example: Legacy Inventory System</div>
                            <p>1. Old monolith app writes to PostgreSQL (unchanged, no code modifications)</p>
                            <p>2. Debezium monitors the database binlog for changes</p>
                            <p>3. When inventory row updates, Debezium automatically streams to Kafka topic</p>
                            <p>4. New analytics service consumes from Kafka, builds real-time dashboards</p>
                            <p>5. Zero changes needed to the legacy app - just add Debezium connector</p>
                        </div>
                    </div>
                </section>

                <!-- Reconciliation -->
                <section class="card" id="2pc">
                    <h2><i class="fa-solid fa-rotate fa-icon"></i>Real-World: Two-Phase Commit with Reconciliation</h2>
                    
                    <p>In production, the patterns above are not enough. A robust implementation uses <strong>Two-Phase Commit (2PC)</strong> or <strong>Multi-Phase Commit</strong> with reconciliation:</p>
                    
                    <div class="insight-box">
                        <div class="insight-icon"><i class="fa-solid fa-lightbulb"></i></div>
                        <div>
                            <strong>Key Insight:</strong> In real systems, failures are not exceptions - they are expected. You need a mechanism to detect and recover from stuck records.
                        </div>
                    </div>
                    
                    <h3>State Machine: Two-Phase Commit</h3>
                    
                    <div class="flow-row">
                        <div class="flow-item" style="background: #E3F2FD;">
                            <strong>INITIALIZED</strong><br><span style="font-size: 0.8rem;">Record created</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item" style="background: #FFF3E0;">
                            <strong>PROCESSING</strong><br><span style="font-size: 0.8rem;">Event emitting</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item" style="background: #F3E5F5;">
                            <strong>EMITTED</strong><br><span style="font-size: 0.8rem;">Wait for ack</span>
                        </div>
                    </div>
                    
                    <div class="flow-row">
                        <div class="flow-item success">
                            <strong>SUCCESS</strong><br><span style="font-size: 0.8rem;">Consumed + txn complete</span>
                        </div>
                        <div style="color: var(--accent-coral); font-weight: bold;">|</div>
                        <div class="flow-item error">
                            <strong>FAILED</strong><br><span style="font-size: 0.8rem;">Consume failed</span>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.95rem; color: var(--text-muted); margin-top: 10px;">
                        <strong>Phase 1:</strong> INITIALIZED -&gt; PROCESSING (mark before emit)<br>
                        <strong>Phase 2:</strong> PROCESSING -&gt; EMITTED (event sent, wait for consumer ack)<br>
                        <strong>Complete:</strong> EMITTED -&gt; SUCCESS (consumer confirmed) or FAILED (consumer rejected)
                    </p>
                    
                    <h3>Reconciliation Process</h3>
                    
                    <div class="flow-row">
                        <div class="flow-item" style="background: #FFEBEE;">
                            <strong>STUCK RECORDS</strong><br><span style="font-size: 0.8rem;">INIT/PROC &gt; threshold</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item" style="background: #FFF8E1;">
                            <strong>RECONCILE</strong><br><span style="font-size: 0.8rem;">Query + decide</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item" style="background: #E3F2FD;">
                            <strong>RETRY</strong><br><span style="font-size: 0.8rem;">Trigger again</span>
                        </div>
                        <div class="flow-arrow">-&gt;</div>
                        <div class="flow-item success">
                            <strong>SUCCESS/FAILED</strong><br><span style="font-size: 0.8rem;">Final state</span>
                        </div>
                    </div>
                    
                    <div class="insight-box" style="margin-top: 20px;">
                        <div class="insight-icon"><i class="fa-solid fa-rotate"></i></div>
                        <div>
                            <strong>Reconciliation Job:</strong> Scheduled job runs periodically (hourly/daily), finds records stuck in INITIALIZED or PROCESSING beyond threshold, then either auto-retry or alert for manual intervention.
                        </div>
                    </div>
                    
                    <h3>How It Works</h3>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">1</span>
                            Create Record in INITIALIZED State
                        </div>
                        <p>Write to database with <code>status = 'initialized'</code>. The business operation is recorded but event is not yet emitted.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">2</span>
                            Mark PROCESSING Before Emit
                        </div>
                        <p>Before emitting the event (via CDC or outbox), atomically update status to <code>processing</code>. This prevents duplicate emission if the process crashes and restarts.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">3</span>
                            Emit Event and Mark EMITTED
                        </div>
                        <p>Send event to Kafka, then update status to <code>emitted</code>. Now wait for consumer acknowledgment.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">4</span>
                            Consumer Confirms: Mark SUCCESS
                        </div>
                        <p>When downstream consumer successfully processes the event and confirms, update to <code>success</code>. Transaction is complete.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">5</span>
                            Consumer Fails: Mark FAILED
                        </div>
                        <p>If consumer rejects or fails to process, update to <code>failed</code> with error details. May trigger compensation logic.</p>
                    </div>
                    
                    <div class="action-card">
                        <div class="action-title">
                            <span class="action-number">6</span>
                            Reconciliation: Fix Stuck Records
                        </div>
                        <p>Scheduled job finds records in <code>initialized</code> or <code>processing</code> beyond threshold. Either auto-retry (re-trigger from EMITTED step) or alert for manual review.</p>
                    </div>
                    
                    <div class="highlight-box">
                        <p><strong>The Safety Net:</strong> Records that never make it to SUCCESS will appear in the reconciliation report. You can then investigate and replay safely because idempotency guarantees no duplicate side effects.</p>
                    </div>
                    
                    <h3>Database Schema Example</h3>
                    
                    <div class="code-block">
<pre>CREATE TABLE outbox (
    id              UUID PRIMARY KEY,
    aggregate_id   UUID NOT NULL,
    event_type      VARCHAR(100) NOT NULL,
    payload        JSONB NOT NULL,
    status         VARCHAR(20) DEFAULT 'initialized',
    retry_count    INT DEFAULT 0,
    created_at     TIMESTAMP DEFAULT NOW(),
    processed_at    TIMESTAMP,
    error_message  TEXT
);

-- Partial index for reconciliation: only index stuck records
CREATE INDEX idx_outbox_stuck 
ON outbox(created_at) 
WHERE status = 'initialized' OR status = 'processing';</pre>
                    </div>
                </section>

                <!-- Comparison -->
                <section class="card" id="comparison">
                    <h2><i class="fa-solid fa-scale-balanced fa-icon"></i>Solution Comparison</h2>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Consistency</th>
                                <th>Complexity</th>
                                <th>Latency</th>
                                <th>Audit Trail</th>
                                <th>Reconciliation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Transactional Outbox</td>
                                <td class="check">[+] Strong</td>
                                <td>Medium</td>
                                <td>Low</td>
                                <td class="cross">[-]</td>
                                <td>Recommended</td>
                            </tr>
                            <tr>
                                <td>Event Sourcing</td>
                                <td class="check">[+] Strong</td>
                                <td>High</td>
                                <td>Medium</td>
                                <td class="check">[+] Complete</td>
                                <td>Built-in</td>
                            </tr>
                            <tr>
                                <td>Listen to Yourself</td>
                                <td class="cross">[-] Eventual</td>
                                <td>Low</td>
                                <td>Very Low</td>
                                <td class="check">[+]</td>
                                <td>Recommended</td>
                            </tr>
                            <tr>
                                <td>CDC</td>
                                <td class="check">[+] Strong</td>
                                <td>Medium</td>
                                <td>Low</td>
                                <td class="cross">[-]</td>
                                <td>Recommended</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Which to Use -->
                <section class="card" id="choose">
                    <h2><i class="fa-solid fa-question fa-icon"></i>Which Pattern to Use?</h2>
                    
                    <div class="strategy-grid">
                        <div class="strategy-card">
                            <div class="strategy-icon" style="background: var(--accent-teal);">[O]</div>
                            <div class="strategy-name">Outbox</div>
                            <div class="strategy-use">Transactional DB</div>
                            <div class="strategy-when">Strong consistency required</div>
                        </div>
                        
                        <div class="strategy-card">
                            <div class="strategy-icon" style="background: var(--accent-sunflower);">[E]</div>
                            <div class="strategy-name">Event Sourcing</div>
                            <div class="strategy-use">Audit trail</div>
                            <div class="strategy-when">Banking, healthcare</div>
                        </div>
                        
                        <div class="strategy-card">
                            <div class="strategy-icon" style="background: var(--accent-lavender);">[L]</div>
                            <div class="strategy-name">Listen to Self</div>
                            <div class="strategy-use">Fast response</div>
                            <div class="strategy-when">Async OK</div>
                        </div>
                        
                        <div class="strategy-card">
                            <div class="strategy-icon" style="background: var(--accent-orange);">[C]</div>
                            <div class="strategy-name">CDC</div>
                            <div class="strategy-use">No code change</div>
                            <div class="strategy-when">Legacy systems</div>
                        </div>
                    </div>
                    
                    <div class="insight-box" style="margin-top: 25px;">
                        <div class="insight-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div><strong>Production tip:</strong> Always add Two-Phase Commit + Reconciliation to any pattern!</div>
                    </div>
                </section>

                <!-- Key Takeaways -->
                <section class="card" id="takeaways">
                    <h2><i class="fa-solid fa-star fa-icon"></i>Key Takeaways</h2>
                    
                    <div class="highlight-box">
                        <p>1. The dual write problem is real and dangerous - do not ignore it!</p>
                        <p>2. Never assume both writes will succeed - plan for failure</p>
                        <p>3. Choose the pattern that fits your consistency requirements</p>
                        <p>4. At-least-once delivery is common - build idempotent consumers</p>
                        <p>5. <strong>Always implement reconciliation for production systems!</strong></p>
                        <p>6. Test your failure scenarios!</p>
                    </div>
                </section>
                
                <footer>
                    <p>Study notes based on Confluent Developer Courses</p>
                    <p>Dual Write Problem | Transactional Outbox | Event Sourcing | CDC | Reconciliation</p>
                </footer>
            </div>
        </main>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                const offset = 30;
                const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
                window.scrollTo({ top: elementPosition - offset, behavior: 'smooth' });
            }
        }

        // Scroll spy
        const sections = document.querySelectorAll('.card[id]');
        const tocLinks = document.querySelectorAll('.toc-list a');

        function highlightToc() {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.scrollY >= sectionTop - 150) {
                    current = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', highlightToc);
        highlightToc();
    </script>
</body>
</html>
